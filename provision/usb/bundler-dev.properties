version  1 
verbose  1
helptext Available modes: 
helptext    Full   - Build a new image (overwriting) and copy all files (including bundled files)
helptext    Create - Build a new image (overwriting) and copy all files required for installation 
helptext             (excludes large bundled data)
helptext    Update - Update an already-built image, update boot files
helptext             (excludes large bundled data)
helptext    Quick  - Update kickstarts, provisioning, boot label etc
helptext             (excludes ISO, non-critical ISO content, and large bundled data)
helptext    Bundle - Update the large data bundles (nexus repository backup, gitlab backup, etc)
helptext    Isos   - Copy the isos on as files
helptext
helptext  Example session:
helptext
helptext   Getting started:
helptext
helptext      ss-bundler --mode=create 
helptext         (you may then test that the USB stick works to build the server)
helptext
helptext   When it is working fine, or after your backups have run, you might
helptext         update with the backup data
helptext      ss-bundler --mode=bundle
helptext   
helptext   NOTE:
helptext
helptext   The way this works, is lines are processed from the top down, 
helptext     reading an ACTION from each line -- however with a line being
helptext     ignored if in a section that specifies it is ONLY for a mode
helptext     that does not match the current selected mode (--mode commandline option).
helptext   After reaching the end of the file, the BUILDER command is invoked with a 
helptext     set of arguments that have been built up by the actions that were processed
helptext     above.
helptext
helptext   Use the 'DRY_RUN 1' action to view the command without execution.
helptext 
helptext   Good luck.

MODES    full create update quick bundle isos bootloader nexus kickstarts menus
DEFAULT  full

builder  ./build-boot-image.py
image    images/boot-image.raw
#image    /dev/sdc
format   qcow2
iso      isos/CentOS-7-x86_64-Everything-1810.iso
label    SSBOOT

# Build up an APPEND commandline. The 'append' action here should not be 
# confused with the kernel append (although it is being used to 
# build up a commandline for a syslinux APPEND directive here) it 
# can be used to build up any variable defined with the VAR action.

var      cmdline 
append   cmdline ' '
append   cmdline inst.kexec inst.kdump_addon=off 
#append   cmdline inst.geoloc=0 inst.resolution=800x600 inst.sshd 
append   cmdline inst.ks=hd:LABEL=SSBOOT:/ks.cfg

# Use this file as the default target for subsequent edits
edit     syslinux/syslinux.cfg

################################################################
ONLY     full 
action   --patch-syslinux
action   --syslinux --overwrite

################################################################
ONLY     full menus update quick
action   --replace --match 'menu title CentOS 7' --search 'CentOS 7' --text 'SoeStack CentOS 7'

# NOTE the 'rescue quiet' is replaced first, without the 'quiet', so that the subsequent
# replacements (that substitute 'quiet' for ARGS) do not affect the 'rescue' boot entry.
action   --replace --match LABEL= --search '~ rescue quiet' --text ' rescue '

# Replace 'quiet' with the string 'ARGS', which will be used later to substitute our
# custom kernel commandline options.
action   --replace --match LABEL= --search '~ quiet.*'      --text ' ARGS '

# Disable the timeout
action   --replace --match timeout --search 'timeout 600'   --text 'timeout 0'

# Stop the 'install' action being the default - instead we want
# to make the 'boot from local drive' option the default (as a safer option).
action   --delete-near --match ~menu.default 
#action   --cat /usb/syslinux/syslinux.cfg
#action   --insert-near --match ^Install --line 1 --text "  menu default"
action   --insert-near --match 'Boot from ^local drive' --line 1 --text "  menu default"

# Subsitute our custom kernel args (built up into the cmdline var) where we
# placed the ARGS token earlier
action   --replace --match LABEL= --search '~ ARGS .*' --text ' ARGS %cmdline%'

# Specify which files to exclude when copying into the image or device
excludes boot-image* *.iso *qcow2 *.raw *.raw--* :vcs-ignores  .git  bundled exclude

#flags    --verbose --debug
################################################################
ONLY     full create
descr    Create a bootable image for CentOS
build    modify --ext4 --minimal --debug  --create --size 10000 --force --copy-isolinux-as-syslinux --copy-iso-files

################################################################
ONLY     update 
descr    Update all files required for boot (exclude large bundled data)
build    modify --ext4 --overwrite --minimal

################################################################
ONLY     bootloader
action   --patch-syslinux
action   --syslinux --overwrite
descr    Install bootloader 
build    --verbose modify --ext4 --overwrite --minimal

################################################################
ONLY     isos full
topdir   /
build    --verbose modify --ext4 
copy     entire dir isos as isos

################################################################
ONLY     quick kickstarts bundle nexus
descr    Quick update mode (kickstarts, soestack provisioning)
# Prepare to modify the image, clearing any automatic actions first
build    modify --ext4 --overwrite --clear

################################################################
ONLY     create full quick update kickstarts
descr    Copy kickstarts
topdir   /
copy     entire dir  ../kickstart
copy     single file ../kickstart/kickstart.cfg as ks.cfg

################################################################
ONLY     bundle full

# All the bundled data will be copied to this subdirectory on the USB.
topdir   bundled

# Copy the SOE so that the machine can be set up as a master
copy     entire dir ../../ as soe

# GPG keys for importing prior to installing packages
# gpgkeys are now provided within provision/common/inc
#copy     entire dir ../common/inc/gpgkeys as gpgkeys

# RPM files that need to be available before Nexus is provisioned
copy     entire dir ./bootstrap-pkgs as bootstrap-pkgs

# Docker images that need to be available before Nexus is provisioned. ie the Nexus image.
copy     entire dir ./docker 

################################################################
# Because the nexus files are so large, a separate mode is provided
# just for updating them, instead of including them with the rest
# of the 'bundled' files.
ONLY full nexus

# NOTE, before a nexus data backup, the following steps need to be
# performed to make sure it has yum repodata available (because it
# seems to discard it after a while)
#   - as root:
#        # delete cached yum data on host
#        yum clean all (possibly with metadata expire flag)
#        # download all repodata - triggering nexus to download it again
#        yum makecache 
#   - then do the nexus database export (from a backup db task)
#   - then stop nexus immediately so that the blobs state is consistent
#     with the exported databases
#
# Nexus blobs and database, so that nexus can be provisioned with 
# an existing cache of packages used by the SOE
#tar      contents dir /d/local/data/nexus/backups as bundled/nexus/db-backup.tar
#tar      entire dir   /d/local/data/nexus/blobs as bundled/nexus/blobs.tar

topdir   bundled/nexus
copy     single file  /d/local/data/nexus/db-backup.tar
copy     single file  /d/local/data/nexus/blobs.tar
